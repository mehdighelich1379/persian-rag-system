from openai import OpenAI
from .retriever import retrieve
from .config import LLM_MODEL, TEMPERATURE


client = OpenAI(api_key="*****")


def generate(query):
    ctxs = retrieve(query)

    if not ctxs:
        return (
            "โ ูุชุฃุณูุงูู ุงุทูุงุนุงุช ูุฑุชุจุท ุฏุฑ ูพุงฺฏุงู ุฏุงูุด ููุฌูุฏ ูุณุช.\n"
            "ูุทูุงู ุณุคุงู ุฎูุฏ ุฑุง ุฏุฑุจุงุฑู ุฑุฒูููุ ุงุณุชุฎุฏุงู ุง ูุณุฑ ุดุบู ูุทุฑุญ ฺฉูุฏ ๐"
        )

    context = "\n\n".join(f"- {c['answer']}" for c in ctxs)

    print("=== RETRIEVED CONTEXT ===")
    print(context[:800])
    print("=========================")

    prompt = f"""
ุชู ฺฉ ูุชุฎุตุต ุญุฑููโุง ููุงุจุน ุงูุณุงู (HR) ูุณุช ุจุง ุชุฌุฑุจู ูุงูุน ุฏุฑ ุงุณุชุฎุฏุงูุ ุจุฑุฑุณ ุฑุฒููู ู ุขููุฒุด ุดุบู.
ุณุจฺฉ ููุดุชูุช ุขููุฒุดุ ฺฉุงุฑุจุฑุฏุ ุดูุงู ู ูุงุจู ููู ุงุณุช.
ูุฎุงุทุจ ุชู ุงูุฑุงุฏ ุฌูุง ฺฉุงุฑ ุง ูุชุฎุตุตุงู ุฌูุงู ูุณุชูุฏ.

ููุงูู ููู:
- ุงุฒ ูุชูโูุง ุฒุฑ ููุท ุจุฑุง ุงููุงู ฺฏุฑูุชู ุงุณุชูุงุฏู ฺฉู
- ุจูโูฺโูุฌู ูุชูโูุง ุฑุง ฺฉูพ ูฺฉู
- ุจุงุฒููุณ ุณุทุญ ุง ุฌููุงุช ูุดุงุจู ูููุณ

ุฎุฑูุฌ ุจุงุฏ:
- ฺฉุงููุงู ุฌุฏุฏ ู ุงุตู ุจุงุดุฏ
- ูุญู ุตูู ุงูุง ุญุฑููโุง ุฏุงุดุชู ุจุงุดุฏ
- ุณุงุฎุชุงุฑููุฏ (ุชุชุฑุ ูพุงุฑุงฺฏุฑุงู ฺฉูุชุงูุ ุฌูุนโุจูุฏ)
- ููุงุณุจ ุงูุชุดุงุฑ ุญุฑููโุง (ูุจูุงฺฏ / ููฺฉุฏู / ุขููุฒุด)
- ุดุงูู emoji ูุญุฏูุฏ ู ูุฏูููุฏ (ุญุฏุงฺฉุซุฑ ณโต ุนุฏุฏ)

ูพุฑูุฒ ฺฉู ุงุฒ:
- ุงุบุฑุงู
- ฺฉูโฺฏู
- ูุญู ุชุจูุบุงุช

ุชูุฑฺฉุฒ ุงุตู: ุงุฑุงุฆู ุงุฑุฒุด ุนูู ู ูุงุจู ุงุณุชูุงุฏู ุจุฑุง ูุฎุงุทุจ.

ูููููโูุง ุงููุงู:
{context}

โ ุฏุฑุฎูุงุณุช ฺฉุงุฑุจุฑ:
{query}

ุญุงูุง ฺฉ ูุชู ุขููุฒุด ุญุฑููโุงุ ฺฉุงุฑุจุฑุฏ ู ุชูุฒ ุจููุณ.
"""

    response = client.chat.completions.create(
        model=LLM_MODEL,
        messages=[{"role": "user", "content": prompt}],
        temperature=TEMPERATURE
    )


    return response.choices[0].message.content
